<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZG8KEL35MW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-ZG8KEL35MW');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>BuzzKill</title>

    <link rel="stylesheet" href="/static/styles.css?v=5">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>


<body>
<div class="container">

    <!-- HERO BANNER -->
    <div class="hero">
        <div class="hero__img"
             style="background-image: url('{{ url_for('static', filename='images/buzzkillheader.png') }}');">
        </div>
    </div>
	
	    <div class="subtitle-container">
            A helpful companion for solving the New York Times 'Spelling Bee' puzzle.
        </div>

    <!-- CARD WRAPPER -->
    <div class="card">

        <div id="loading" style="display:none;"></div>

        <div class="input-container">
            <label for="common_pool">Enter today's letters (7 letters):</label>
            <input type="text" id="common_pool" name="common_pool"
                   class="custom-input" autocomplete="off">
            <div id="common_pool_error" class="error-message"></div>
        </div>

        <div class="input-container">
            <label for="filter_letter">Enter the center letter to filter the list:</label>
            <input type="text" id="filter_letter" name="filter_letter"
                   class="custom-input" autocomplete="off">
            <div id="filter_letter_error" class="error-message"></div>
        </div>

        <button class="submit-button" id="submit-btn" onclick="fetchData()">Submit</button>

		<!-- TOGGLE ROW (aligned) -->
		<div class="input-container input-toggle-row">
		  <label class="bk-toggle" for="use-curated">
			<input type="checkbox" id="use-curated">
			<span class="bk-box" aria-hidden="true"></span>
			<span class="bk-text">Toggle likely words only</span>
		  </label>

		  <button type="button"
				  class="info-tip"
				  aria-label="What does 'Likely words only' mean?"
				  data-tooltip="Curated list based on all previous NYT Spelling Bee puzzles. Click to toggle on and off.">?</button>
		</div>
		
		<div id="summary-count" class="summary-count" aria-live="polite"></div>

        <div class="matching-words" id="matching-words"></div>


        <footer>
            <div id="copyright">
                &copy; <a href="https://graemehimself.forsale"
                          target="_blank" rel="noopener noreferrer">
                    graeme r hay <span id="current-year"></span></a>
            </div>
        </footer>

    </div> <!-- end card -->

</div> <!-- end container -->


<script>
document.addEventListener("DOMContentLoaded", function() {

    const submitBtn = document.getElementById("submit-btn");
    const commonPoolInput = document.getElementById("common_pool");
    const filterLetterInput = document.getElementById("filter_letter");
    const curatedToggle = document.getElementById("use-curated");

    submitBtn.addEventListener("click", function() {
        document.getElementById("loading").style.display = "block";
        fetchData();
    });

    commonPoolInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); fetchData(); }
    });

    filterLetterInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); fetchData(); }
    });

    let toggleTimer;
    curatedToggle.addEventListener("change", function () {
        const common = document.getElementById("common_pool").value.replace(/\s/g, '');
        const center = document.getElementById("filter_letter").value.replace(/\s/g, '');

        if (common.length !== 7 ||
            center.length !== 1 ||
            !common.toLowerCase().includes(center.toLowerCase())) {
            return;
        }

        document.getElementById("loading").style.display = "block";
        clearTimeout(toggleTimer);
        toggleTimer = setTimeout(fetchData, 150);
    });

    const currentYear = new Date().getFullYear();
    document.getElementById("current-year").textContent = currentYear;
});


function fetchData() {

    const commonPool = document.getElementById("common_pool").value;
    const filterLetter = document.getElementById("filter_letter").value;
    const useCurated = document.getElementById("use-curated").checked;

    const commonPoolClean = commonPool.replace(/\s/g, '');
    const filterLetterClean = filterLetter.replace(/\s/g, '');

    const commonPoolLower = commonPoolClean.toLowerCase();
    const filterLetterLower = filterLetterClean.toLowerCase();

    document.getElementById("common_pool_error").innerHTML = "";
    document.getElementById("filter_letter_error").innerHTML = "";

    if (commonPoolClean.length !== 7) {
        document.getElementById("common_pool_error").innerHTML =
            `You have entered ${commonPoolClean.length} letters, please input 7 exactly.`;
        return;
    }

    if (filterLetterClean.length !== 1 ||
        !commonPoolLower.includes(filterLetterLower)) {
        document.getElementById("filter_letter_error").innerHTML =
            "Please input exactly one center letter that is also part of the 7 letters you provided.";
        return;
    }

    const data = {
        common_pool: commonPoolClean,
        filter_letter: filterLetterClean,
        use_curated: useCurated
    };

    fetch('/process_input', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data),
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            displayResults(data);
        } else {
            displayError(data.message);
        }
    })
    .catch(() => displayError('An error occurred while processing your request.'));
}


function displayResults(data) {
    // total across all first-letter buckets
    const total = Object.values(data.counts || {}).reduce((a, b) => a + b, 0);

    // summary line
    const summaryEl = document.getElementById('summary-count');
    summaryEl.innerHTML = `<span class="count-pill">Found <strong>${total}</strong> matching word${total !== 1 ? 's' : ''}</span>`;

    // existing grouped rendering
    let html = '';
    for (const [letter, wordLengthData] of Object.entries(data.result)) {
      html += `<h2 style="color: white; text-align: left;">${letter} (${data.counts[letter]} matching words)</h2>`;
      for (const [wordLength, wordData] of Object.entries(wordLengthData)) {
        html += `<div><span class="word-length">[${wordLength}]</span> `;
        for (let i = 0; i < wordData.length; i++) {
          const [word, isPangram] = wordData[i];
          html += isPangram ? `<span class="pangram">${word}</span>` : word;
          if (i < wordData.length - 1) html += ', ';
        }
        html += `</div>`;
      }
      html += `<br>`;
    }
    document.querySelector('.matching-words').innerHTML = html;
    document.getElementById("loading").style.display = "none";
  }

  function displayError(message) {
    document.getElementById('summary-count').innerHTML = '';
    document.querySelector('.matching-words').innerHTML = `<div class="error-message">${message}</div>`;
    document.getElementById("loading").style.display = "none";
  }
  
</script>

</body>
</html>
